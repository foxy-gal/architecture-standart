### <a name="_b7urdng99y53"></a>**Название задачи:** 
Доступ кол-центров к актуальным депозитным ставкам в MVP (внутренний API + файловая выгрузка партнёру)

### <a name="_hjk0fkfyohdk"></a>**Автор:**
Анна Б

### <a name="_uanumrh8zrui"></a>**Дата:**
07.01.2026

### <a name="_3bfxc9a45514"></a>**Функциональные требования**
Опишите здесь верхнеуровневые Use Cases. Их нужно оформить в виде таблицы с пошаговым описанием:

|**№**|**Действующие лица или системы**|**Use Case**|**Описание**|
| :-: | :- | :- | :- |
|1|Сотрудник кол-центра банка → Система кол-центра → Депозитная платформа MVP|Просмотр актуальных ставок (банк)|1) Оператор открывает карточку/скрипт «Депозиты». 2) Система кол-центра запрашивает «текущие ставки» у Депозитной платформы MVP. 3) Платформа возвращает список депозитов/тарифов и условия (сроки, мин. сумма, валюта, дата актуальности). 4) Оператор озвучивает клиенту условия.|
|2|Депозитная платформа MVP → (файловый обмен) → Партнёрский кол-центр|Передача актуальных ставок файлом партнёру|1) При изменении ставок (или по расписанию) платформа формирует «снимок ставок». 2) Генерируется файл в согласованном формате (например, CSV/JSON) с версией схемы и датой актуальности. 3) Файл отправляется партнёру через согласованный файловый канал (без API-вызовов со стороны партнёра). 4) Партнёр импортирует файл в свою систему и консультирует клиентов.|
|3|Оператор/владелец продукта → Депозитная платформа MVP|Публикация/обновление ставок (в рамках MVP)|1) Уполномоченный сотрудник обновляет ставки/условия в источнике ставок в рамках MVP (как минимум — в Депозитной платформе). 2) Платформа валидирует правила и активирует новую версию ставок. 3) Обновления становятся доступны через внутренний API и попадают в выгрузку для партнёра.|
|4|Депозитная платформа MVP → Система мониторинга/дежурная смена|Контроль доставки файлов партнёру|1) Платформа фиксирует факт генерации/отправки файла (идентификатор, время, версия). 2) При ошибке отправки/формата создаётся инцидент/алёрт. 3) Дежурная смена получает уведомление и запускает повтор/эскалацию.|
|5|ИБ/Безопасность → Депозитная платформа MVP|Аудит доступа к ставкам|1) Любой запрос ставок из кол-центра логируется (кто/когда/что запрашивал). 2) По запросу ИБ формируется отчёт по доступам и изменениям ставок.|

### <a name="_u8xz25hbrgql"></a>**Нефункциональные требования**
Опишите здесь нефункциональные требования и архитектурно значимые требования.

|**№**|**Требование**|
| :-: | :- |
|1|Единый источник правды по «текущим ставкам» в MVP: ставки, отдаваемые кол-центрам, должны совпадать со ставками, используемыми онлайн-каналами (без ручного дублирования).|
|2|Безопасность внутреннего доступа: TLS, аутентификация сервис–сервис (например, OAuth2 client credentials / mTLS), авторизация по ролям (минимально необходимые права).|
|3|Файловая выгрузка партнёру не через API-вызовы со стороны партнёра: банк должен «пушить» файлы в согласованный канал обмена.|
|4|Целостность и актуальность: в файле и в API должны быть дата/время актуальности и версия набора ставок; желательно — контрольная сумма файла (hash) и версия схемы.|
|5|Наблюдаемость: метрики/логи/трейсы по запросам ставок и по пайплайну выгрузки (генерация, отправка, ретраи).|
|6|Надёжность выгрузки: повторные попытки, идемпотентность (повторная отправка того же снапшота не ломает импорт), хранение последнего успешного снапшота.|
|7|Производительность: получение ставок оператором кол-центра должно укладываться в разумное время (ориентир: < 1–2 сек на запрос в 95 перцентиле при нормальной нагрузке).|
|8|Совместимость: формат файла должен быть простым для импорта (CSV/JSON), кодировка UTF-8, фиксированный договорённый справочник валют/сроков, версионирование полей.|
|9|Конфиденциальность: ставки сами по себе обычно не ПДн, но канал передачи файлов должен быть защищён (шифрование/закрытый контур/защищённая почта).|
|10|Ограничение периметра: партнёрский кол-центр не получает доступ внутрь банковского контура (никаких прямых подключений к внутренним API/БД).|

### <a name="_qmphm5d6rvi3"></a>**Решение**
Диаграмма контекста в этой же директории "диаграмма_контекста.png"
Диаграмма контейнера в этой же директории "диаграмма_контейнера.png" 

#### Ключевые решения и логика выбора
- В MVP уже есть «Депозитная платформа», в которой сосредоточены ставки/правила и логика их применения для онлайн-каналов. Логично расширить её как единый источник «текущих ставок», чтобы кол-центры не жили отдельной жизнью.
- Для внутреннего кол-центра нужен интерактивный доступ (API), чтобы оператор мог быстро отвечать клиенту «здесь и сейчас».
- Для партнёра API недоступен, но они готовы принимать файлы — значит, делаем надёжную файловую витрину ставок с пуш-доставкой.

**Архитектурное решение (в MVP)**
1) **Rates API (внутренний)** в Депозитной платформе MVP  
   - REST/JSON эндпоинт вида `GET /rates/current` (и при необходимости фильтры: валюта/срок/канал).  
   - Возвращает только «текущие, неперсональные» ставки банка (именно то, что нужно для консультаций).  
   - Защита: сервисная аутентификация (OAuth2/mTLS) + авторизация по ролям (только «CallCenterRatesRead»).  
   - Логи аудита по запросам.

2) **Сервис выгрузки ставок (Rate Exporter)** в Депозитной платформе MVP  
   - Триггер: по событию изменения ставок и/или по расписанию (например, каждый час + немедленно при изменениях).  
   - Генерация «снапшота» ставок в согласованном формате:
     - файл `rates_<YYYYMMDD_HHMM>_v<schema>.csv` (или `.json`),
     - рядом `manifest.json` (версия схемы, дата актуальности, hash, количество строк).
   - Хранение последнего успешного снапшота внутри банка для повторной отправки и расследований.

3) **Канал доставки файлов партнёру без API-вызовов со стороны партнёра**  
   - Используем **банковский шлюз управляемого файлового обмена / защищённую почту** (вариант выбирается по возможностям банка и партнёра).  
   - Требования: шифрование (например, PGP/S-MIME при почте), контроль целостности (hash), журналирование отправок, ретраи.

4) **Интеграция в систему кол-центра банка**  
   - Добавить в интерфейс оператора виджет/раздел «Актуальные ставки».  
   - На стороне бэкенда кол-центра — интеграция с Rates API, локальный кэш (например, 1–5 минут) и graceful fallback (показ последнего кэша при недоступности платформы).

**Почему это покрывает проблему перегруза**
- Операторы банка и партнёра видят одинаковые «актуальные ставки» из одного источника.
- Партнёру не нужен доступ в периметр банка.
- Файловый обмен снимает ограничение «без API», а внутренняя витрина через API ускоряет консультации.

### <a name="_bjrr7veeh80c"></a>**Альтернативы**
Опишите здесь наиболее важные альтернативные решения.

1) **Сделать отдельную БД ставок в системе кол-центра и поддерживать вручную**  
   - Плюсы: быстро стартануть без интеграции.  
   - Минусы: гарантированная рассинхронизация, человеческий фактор, нет единого источника правды.

2) **Дать партнёру доступ к внутреннему API (VPN/выделенный канал)**  
   - Плюсы: почти онлайн-актуальность, меньше ETL.  
   - Минусы: расширение периметра, сложная безопасность/согласования, противоречит требованию «внешняя система» и фактически превращает партнёра во внутреннего потребителя.

3) **Партнёр берёт ставки с публичного сайта**  
   - Плюсы: нулевая интеграция.  
   - Минусы: нет SLA/аудита/гарантий формата, возможны изменения UI, риски юридически некорректного информирования, неудобно для операторов.

4) **Только расписание выгрузки (без событий при изменениях)**  
   - Плюсы: проще реализация.  
   - Минусы: при частых изменениях ставок повышается риск, что партнёр консультирует по устаревшей информации.

**Недостатки, ограничения, риски**

- **Задержка актуальности у партнёра:** даже при частых выгрузках между изменением ставок и импортом будет лаг. Митигируем: выгрузка «по событию + по расписанию», метка актуальности, операционный контроль.
- **Риски доставки файла:** письмо/файловый шлюз может временно «падать». Митигируем: ретраи, хранение снапшота, алёрты, ручной повтор.
- **Версионирование формата:** партнёрский импорт может сломаться при изменении структуры. Митигируем: версия схемы, обратная совместимость, контрактное тестирование на файлах-примерах.
- **Нагрузка на Rates API при пике звонков:** Митигируем: кэш в системе кол-центра, ограничение частоты, горизонтальное масштабирование сервиса ставок.
- **Оргриски:** согласование канала обмена файлами и ключей шифрования (если PGP/S-MIME) может занять время. Митигируем: начинать с самого простого согласованного безопасного канала, параллелить юридические/ИБ согласования.
