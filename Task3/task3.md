### <a name="_b7urdng99y53"></a>**Название задачи:** 
ADR: Концептуальная архитектура MVP открытия депозитов (сайт + интернет-банк)

### <a name="_hjk0fkfyohdk"></a>**Автор:**
Анна Б

### <a name="_uanumrh8zrui"></a>**Дата:**
07.01.2026

### <a name="_3bfxc9a45514"></a>**Функциональные требования**
Верхнеуровневые Use Cases:

|**№**|**Действующие лица или системы**|**Use Case**|**Описание**|
| :-: | :- | :- | :- |
| 1 | Клиент → Публичный сайт → Депозитная платформа (API) → Сервис ставок | Просмотр депозитов на сайте | 1) Клиент открывает страницу депозитов на сайте. 2) Сайт запрашивает актуальный каталог депозитов и ставок у Сервиса ставок (через API). 3) Сервис ставок возвращает список депозитов, параметры и ставки (с учётом дат действия/версий). 4) Сайт отображает список по дизайн-системе. |
| 2 | Клиент → Публичный сайт → Депозитная платформа (Сервис заявок/лидов) → Система кол-центра (банк) → (опционально) Партнёрский кол-центр | Подача заявки с сайта (лид) и передача в кол-центр | 1) Клиент вводит ФИО и телефон и отправляет заявку. 2) Сайт валидирует формат данных и отправляет лид в Сервис заявок/лидов по TLS. 3) Сервис создаёт заявку со статусом **создана**, присваивает ID и сохраняет ФИО/телефон в защищённом хранилище. 4) Сервис публикует событие **LeadCreated** в шину событий и/или вызывает API системы кол-центра банка (надёжная доставка + ретраи). 5) Кол-центр получает заявку и отображает менеджеру. 6) (При необходимости) кол-центр маршрутизирует лид в партнёрский кол-центр по согласованному защищённому каналу (API/VPN/SFTP — по договору). |
| 3 | Менеджер кол-центра → Система кол-центра → Депозитная платформа (Сервис заявок/условий) | Предложение особых условий по результату звонка | 1) Менеджер открывает карточку лида. 2) Во время/после звонка менеджер фиксирует результат и (при необходимости) вводит/выбирает «особые условия» (ставка/параметры). 3) Система кол-центра отправляет обновление условий в Сервис заявок/условий (или публикует событие **SpecialTermsProposed**). 4) Сервис валидирует допустимость условий по правилам/лимитам и сохраняет версию условий + аудит (кто/когда). 5) Статус заявки меняется на **в обработке** / **ставка подтверждена** (в зависимости от этапа). 6) Клиенту может быть показано «что дальше: визит в отделение для идентификации». |
| 4 | Клиент → Интернет-банк → Депозитная платформа (API) → Сервис ставок/персонализации | Просмотр депозитов и персонализированных ставок в интернет-банке | 1) Клиент авторизуется в ИБ. 2) ИБ запрашивает каталог депозитов и ставки, передавая идентификатор клиента. 3) Сервис ставок/персонализации применяет правила персонализации (сегмент/признаки клиента) и возвращает «базовые + персональные» ставки. 4) ИБ отображает витрину по дизайн-системе и с «миллисекундным» откликом (кэш/предзагрузка). |
| 5 | Клиент → Интернет-банк → Депозитная платформа (Сервис заявок) → СМС-сервис ядра/СМС-шлюз | Подача заявки на открытие депозита в ИБ с подтверждением СМС-кодом | 1) Клиент выбирает депозит, счёт списания/зачисления, сумму, срок и параметры. 2) ИБ выполняет клиентскую валидацию и отправляет черновик заявки в Сервис заявок. 3) Сервис заявок проводит «лёгкую» серверную валидацию на основе кэшированных/реплицированных справочников и правил (без тяжёлых синхронных обращений к АБС). 4) Сервис инициирует подтверждение по СМС через существующий СМС-функционал ядра (без доработок подрядчиком) и переводит заявку в статус **ожидает подтверждения**. 5) Клиент вводит код. 6) Сервис подтверждает код и фиксирует заявку в статус **создана/в обработке** (готова для бэк-офиса). |
| 6 | Менеджер бэк-офиса → Back-office UI (в Депозитной платформе) → АБС (интеграционный адаптер) → Сервис уведомлений → СМС | Ручная обработка заявки, фиксация в АБС, статусы и уведомления | 1) Менеджер бэк-офиса открывает очередь заявок в Back-office UI. 2) Проверяет параметры/условия, при необходимости подтверждает ставку (в рамках правил и прав доступа) и фиксирует решение. 3) Сервис заявок публикует событие **RateConfirmed** (триггер №1 для СМС). 4) Для открытия депозита сервис вызывает интеграционный адаптер к АБС (через очередь/асинхронно, с идемпотентностью). 5) Адаптер создаёт депозит в АБС (PL/SQL операции) и возвращает результат. 6) Сервис заявок фиксирует статус **открыта** или **отклонена**, сохраняет аудит (кто/когда) и публикует событие **DepositOpened**/**ApplicationRejected** (триггер №2 для СМС). 7) Клиент видит трекинг статуса в ИБ/на сайте (polling/кэш). |

### <a name="_u8xz25hbrgql"></a>**Нефункциональные требования**
Нефункциональные требования и архитектурно значимые требования:

|**№**|**Требование**|
| :-: | :- |
| 1 | Доступность 24/7, 99,9% для депозитного сервиса и онлайн-каналов. |
| 2 | Отказоустойчивость между ЦОД: фейловер на резервный ЦОД для ключевых компонентов (онлайн-каналы + депозитная платформа). |
| 3 | Изоляция АБС: исключить прямую работу ИБ с БД АБС; ограничить нагрузку на АБС (очереди/лимитирование/бекпрешер). |
| 4 | Надёжная доставка событий/уведомлений (СМС, статусы): идемпотентность, ретраи, дедупликация, «по крайней мере один раз» на интеграциях. |
| 5 | «Миллисекундный» отклик UI (каталог/параметры/статусы): кэширование, предзагрузка, быстрые чтения. |
| 6 | Устранить проблему медленных справочников (>1 секунды): локальный кэш/реплика справочных данных, контроль TTL и прогрев. |
| 7 | Горизонтальное масштабирование веб/ИБ/новых сервисов и балансировка по серверам/приложениям/ЦОД. |
| 8 | Защита от пиков заявок без деградации АБС: очередь, лимитирование, backpressure, graceful degradation. |
| 9 | Шифрование трафика при передаче чувствительных данных (TLS; для внутренних интеграций — по возможности mTLS). |
| 10 | Единый источник ставок/правил вместо XLS: версии, даты действия, права доступа, единое ведение для депозитов и кредитов. |
| 11 | Аудит и трассируемость: кто/когда поменял ставку, кто подтвердил условия, история статусов заявки. |
| 12 | Наблюдаемость: логи/метрики/трассировка, алёрты, мониторинг SLA/SLO (99,9%, latency). |
| 13 | Документация: архитектурная + интеграционная (API, события, статусы, ошибки). |
| 14 | Совместимость с технологиями банка; предпочтительно MS SQL и Oracle для новых хранилищ/интеграций. |
| 15 | Очереди сообщений: ориентир на Kafka «на перспективу», учитывая ограничения текущей платформы ИБ. |
| 16 | Ограничение: АБС масштабируется только вертикально → профиль нагрузки и интеграции должны это учитывать. |

### <a name="_qmphm5d6rvi3"></a>**Решение**
Диаграмма контекста в этой же директории "диаграмма_контекста.png"
Диаграмма контейнера в этой же директории "диаграмма_контейнера.png" 

#### Ключевые решения и логика выбора

1) **Вводим “Депозитную платформу MVP” как прослойку между онлайн-каналами и АБС**  
- **Цель:** выполнить требования изоляции АБС, убрать прямые обращения ИБ к АБС и снизить риск перегрузки Oracle/PLSQL.  
- **Что берёт на себя платформа:** заявки, статусы, аудит, витрина ставок, персонализация, интеграции и событийность.

2) **Ставки и правила — отдельный “единый источник” вместо XLS**  
- В MVP создаём **Сервис ставок и правил** + простое **back-office UI** для управления (RBAC, версии, даты действия, аудит).  
- **Доступ:** бэк-офис депозитов/кредитов (с разграничением прав).  
- Закрывает архитектурно значимое требование: **«отказаться от XLS как единственного источника»**.

3) **Асинхронная интеграция с АБС (очередь + адаптер), синхронно — только “легкие” операции**  
- UI-операции (каталог/параметры/статусы) должны быть быстрыми → читаем из **кэша/read-модели**.  
- Открытие депозита в АБС — через **ABSAdapter** асинхронно, с идемпотентностью и ретраями.  
- Для пиков: **очередь + лимитирование** на входе (API Gateway) + **backpressure**.

4) **СМС подтверждение — переиспользуем ядро без доработок подрядчиком**  
- Депозитная платформа вызывает существующий **СМС-функционал ядра**.  
- Уведомления клиенту — событийно (**два триггера**: подтверждение ставки и открытие депозита).

5) **Трекинг статуса заявки — единый для сайта и ИБ**  
- Статусы хранятся в **Сервисе заявок (workflow)**.  
- Каналы получают статусы через **API** (polling с кэшированием).  
- **Статусы:** создана → в обработке → ставка подтверждена → открыта / отклонена (+ тех. статусы: ожидает СМС, ошибка, на доработке).

6) **Отказоустойчивость и масштабирование**  
- Новые сервисы проектируем **stateless** → горизонтальное масштабирование.  
- Развёртывание в двух ЦОД: минимум **active-passive** с быстрым фейловером; целевой вариант — **active-active** (зависит от инфраструктуры брокера/БД).  
- Кэш/read-модель прогревается и реплицируется, чтобы выдержать **«миллисекундный» UX**.

7) **Безопасность данных (ФИО+телефон и банковские данные)**  
- Внешний трафик: **HTTPS/TLS**, WAF, rate limiting, защита от ботов/скрейпинга ставок (по политике).  
- Внутренние интеграции: по возможности **mTLS**, сервисные аккаунты, секреты в vault.  
- Логи без ПДн (маскирование), аудит отдельно.

#### Какие IT-команды участвуют (минимально для MVP)

- **Команда сайта (PHP/React):** витрина депозитов, форма лида, трекинг статуса (для лида).  
- **Команда интернет-банка (ASP.NET MVC 4.5):** экран депозитов, персональные ставки, форма заявки, статусы.  
- **Команда “Депозитной платформы” (новая/выделенная):** сервисы ставок/заявок/уведомлений, back-office UI, API Gateway, кэш/read-модель, события.  
- **Команда АБС (Delphi/Oracle/PLSQL):** контракт открытия депозита, доработки/хранимые процедуры, поддержка адаптера, контроль нагрузки.  
- **Команда кол-центра (подрядчик + внутренние Java-специалисты):** приём лидов/обновление условий/маршрутизация к партнёру.  
- **Интеграционная/платформенная команда + DevOps/SRE:** брокер сообщений, мониторинг, CI/CD, развёртывания по ЦОД, сетевые политики.  
- **ИБ/безопасность:** TLS/mTLS, WAF, управление доступами, соответствие требованиям ПДн.  
- **Операционный бэк-офис депозитов:** процессы обработки, права, регламенты, шаблоны коммуникаций.  


### <a name="_bjrr7veeh80c"></a>**Альтернативы**
1) **Оставить прямую интеграцию интернет-банка с АБС (как сейчас с БД)**  
- **Плюсы:** быстро, минимум новых компонентов.  
- **Минусы:** нарушает требование «не использовать прямую работу ИБ с АБС», высокий риск перегрузки Oracle/PLSQL, сложно обеспечить 99,9% и защиту от пиков.

2) **Синхронно открывать депозит в АБС в момент заявки**  
- **Плюсы:** проще для консистентности «сразу открыт».  
- **Минусы:** тяжелые синхронные обращения, деградация UX, риск падения АБС, сложно масштабировать, не выдержит пики.

3) **Оставить XLS источником ставок, просто “раздать” его каналам**  
- **Плюсы:** быстро для MVP.  
- **Минусы:** нет единого контроля версий/дат действия, нет аудита, высокий операционный риск, сложно масштабировать на кредиты/депозиты.

4) **ESB / тяжелый интеграционный слой вместо легкой депозитной платформы**  
- **Плюсы:** стандартизация интеграций.  
- **Минусы:** дороже и дольше по срокам, избыточно для MVP, риск “монолита интеграций”, сложнее обеспечить «миллисекундный» UX.

5) **RabbitMQ / ActiveMQ вместо Kafka**  
- **Плюсы:** проще стартануть, иногда легче вписать в текущие стеки.  
- **Минусы:** стратегически расходится с ориентиром на Kafka; возможны миграционные затраты.  
- **Компромисс:** абстрагировать шину событий контрактами и подписчиками, чтобы позже переехать на Kafka.

**Недостатки, ограничения, риски**

- **Зависимость от подрядчика интернет-банка:** любые изменения ядра/интеграций могут упираться в релизный цикл подрядчика.  
- **Совместимость с Kafka и текущей платформой ИБ:** если прямой клиент Kafka в ИБ невозможен, все события скрываем за депозитной платформой (ИБ общается только по REST).  
- **Сложность отказоустойчивости между ЦОД:** брокер/БД/кэш должны поддерживать выбранный режим (active-passive/active-active), иначе 99,9% будет достигаться только частично.  
- **Консистентность статусов:** асинхронная АБС-интеграция → eventual consistency; важно корректно объяснять клиенту статусы и «что дальше».  
- **Безопасность ПДн с сайта:** ФИО+телефон → строгие требования к TLS, хранению, маскированию логов, доступам.  
- **Идемпотентность и дубликаты:** ретраи на очередях/HTTP → обязательны ключи идемпотентности (application_id, event_id), дедупликация уведомлений/открытий.  
- **Нагрузка на АБС все равно возможна:** если бэк-офис будет массово “пробивать” открытия, нужен лимит/пулы, очереди, окна обработки.  
- **Качество данных для персонализации:** если источники сегментов/признаков клиента не готовы, персонализация в MVP может быть упрощённой (правила по ограниченному набору атрибутов).  
- **Партнёрский кол-центр:** внешние интеграции зависят от договора и техвозможностей партнёра (канал, SLA, форматы).  

